<html>
<head>
    <script type="text/javascript" language="javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" language="javascript"
            src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.1/underscore-min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.0/backbone-min.js"></script>

    <link type="text/css" href="{{contextPath}}/css/ui.jqgrid.css" rel="stylesheet"/>
    <script type="text/javascript" src="{{contextPath}}/js/libs/mustache.js"></script>
    <script type="text/javascript" src="{{contextPath}}/js/libs/list.js"></script>
    <script type="text/javascript" src="{{contextPath}}/js/helpers/TemplateLoader.js"></script>
    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/libs/grid.locale-en.js"></script>
    <script type="text/javascript" language="javascript"
            src="{{contextPath}}/js/libs/jquery.i18n.properties-min.js"></script>
    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/libs/jquery.form.js"></script>
    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/helpers/utils.js"></script>

    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/libs/fileuploader.js"></script>

    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/helpers/BackboneSync.js"></script>
    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/admin/PackageModel.js"></script>
    <script type="text/javascript" language="javascript" src="{{contextPath}}/js/admin/PackageView.js"></script>
    <script type="text/javascript" src="{{contextPath}}/js/libs/blockUI.js"></script>

    <link type="text/css" href="{{contextPath}}/css/custom-theme/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
    <link type="text/css" rel="stylesheet" href="{{contextPath}}/css/scorm_main.css"/>
    <link type="text/css" rel="stylesheet" href="{{contextPath}}/css/scorm_admin.css"/>

    <script type="text/javascript" language="javascript">
        var scormPackages = new PackageModelCollection();
        var scormLanguageData = {};

        $(function () {
            Utils.i18nLoader(Utils.getContextPath() + '/i18n/admin_{{language}}.properties', onLanguageLoad, loadDefaultLanguage);
        });

        function loadDefaultLanguage() {
            Utils.i18nLoader(Utils.getContextPath() + '/i18n/admin_en.properties', onLanguageLoad, onLanguageError);
        }

        function onLanguageLoad(properties) {
            scormLanguageData = properties;
            initView();
        }

        function onLanguageError() {
            alert('Translation resource loading failed!');
        }

        function initView() {
            var loader = new TemplateLoader();
            loader.on('complete', function () {
                var scormPackagesView = new PackageListView({el:$("#packageList"), collection:scormPackages, language:scormLanguageData});
                $("#packageSearch").keyup(function () {
                    scormPackagesView.filterPackages($("#packageSearch").val());
                });
                scormPackages.fetch();
            }, this);
            loader.fetch("templates/admin_templates.html");

            $("#SCORMPackageUploadButton").button().click(showUploadDialog);

            $("#SCORMPackageAdminButton").button().click(function () {
                $('#SCORMAdminDialog').dialog('open');
            });

            $('#SCORMUploadDialog').dialog({autoOpen:false, width:350});
            $('#SCORMAdminDialog').dialog({autoOpen:false, width:400});

            /*{{#isAdmin}}*/
            resetDBInfo();
            /*{{/isAdmin}}*/
        }

        function uploadPackage() {
            $('#projectLearnGeneric').block({ message:"{{overlayProcessMessageLabel}}" });
            var fileName = $("#newPackages")[0].value;
            var parts = fileName.split(".");
            var fileType = parts[parts.length - 1].toLowerCase();
            var allowedTypes = ['zip'];
            var passed = false;
            for (i in allowedTypes)
                if (allowedTypes[i] == fileType) passed = true;
            if (passed) $('#uploadForm').ajaxSubmit({
                type:"POST",
                url:Utils.getContextPath() + '/services/upload/package',
                dataType:'json',
                success:function (data) {
                    scormPackages.add({id:data.id,
                        title:$("#SCORMPackageTitle").val(),
                        summary:$("#SCORMPackageSummary").val(),
                        visibility:true});
                    $('#SCORMUploadDialog').dialog('close');
                    $('#projectLearnGeneric').unblock();
                    $.growlUI('{{overlayProcessPackageMessageLabel}}', '{{overlayCompleteMessageLabel}}');
                },
                error:function () {
                    $('#projectLearnGeneric').unblock();
                    $.growlWarning('{{overlayProcessPackageMessageLabel}}', '{{overlayFailedMessageLabel}}');
                }
            });
            else {
                $('#projectLearnGeneric').unblock();
                $.growlWarning('{{overlayProcessPackageMessageLabel}}', '{{overlayFailedMessageLabel}}');
            }
            return false;
        }

        function showUploadDialog() {
            $('#qq-upload-list').text("");
            $('#SCORMPackageTitle').val("");
            $('#SCORMPackageSummary').val("");
            $('#SCORMUploadDialog').dialog('open');
        }

        /*{{#isAdmin}}*/
        function saveDatabase() {
            $('#settingsForm').ajaxSubmit({
                type:"POST",
                url:Utils.getContextPath() + '/services/administering/UpdateSettings',
                dataType:'html',
                success:function (data) {
                    scormPackages.fetch();
                    $('#SCORMAdminDialog').dialog('close');
                }
            })
        }

        function renewDatabase() {
            if (confirm("{{renewDatabaseWarningLabel}}")) {
                $.post(Utils.getContextPath() + '/services/administering/RenewDatabase', function (data) {
                    alert("{{renewDatabaseCompleteLabel}}");
                    scormPackages.fetch();
                });
            }
        }

        function resetDBInfo() {
            $.get(Utils.getContextPath() + '/services/administering/GetSettings', function (data) {
                $('#SCORMServerName').val(data.server);
                $('#SCORMDatabaseName').val(data.database);
                $('#SCORMDatabaseUserLogin').val(data.login);
                $('#SCORMDatabaseUserPassword').val(data.password);
            });
        }
        /*{{/isAdmin}}*/
    </script>
</head>
<body>
<div class="projectLearnGeneric" id="projectLearnGeneric">
    <div class="SCORMTitle">{{pageSubTitleLabel}}</div>
    <br clear="all"/>

    <div class="SCORMWell">
        <div style="float: left">
            <input placeholder="{{searchPlaceholderLabel}}" type="text" id="packageSearch" class="SCORMSearch"/>
        </div>
        <!--{{#isAdmin}}-->
        <div style="float: right">
            <abbr title="{{administeringDialogButtonTooltipLabel}}">
                <button id="SCORMPackageAdminButton" class="button32 buttonAdmin"></button>
            </abbr>
        </div>
        <!--{{/isAdmin}}-->
        <div style="float: right">
            <abbr title="{{packageUploadDialogButtonTooltipLabel}}">
                <button id="SCORMPackageUploadButton" class="button32 buttonAddPackage"></button>
            </abbr>
        </div>
        <br style="clear: both"/>

        <div id="packageList" class="SCORMPackageList"></div>
    </div>

    <div id="SCORMUploadDialog" title="{{packageUploaderDialogTitleLabel}}">
        <form id="uploadForm" action="" enctype="multipart/form-data">
            <b id="SCORMPackageTitleLabel" class="SCORMPackageLabel">{{packageUploaderDialogNameLabel}}</b><br>
            <input type="text" name="title" id="SCORMPackageTitle" class="SCORMGreyLabel">

            <b id="SCORMPackageSummaryLabel" class="SCORMPackageLabel">{{packageUploaderDialogSummaryLabel}}</b><br>
            <textarea name="summary" id="SCORMPackageSummary" class="SCORMGreyLabel" rows=4 cols=30></textarea>
            <br>
            <input type="file" name="file" id="newPackages" class="SCORMGreyLabel"/>
            <input id="SCORMUpload" type="button" onclick="uploadPackage()" class="textbutton SCORMUpload"
                   value="{{packageUploaderDialogUploadButtonLabel}}"/>
        </form>
    </div>
    <!--{{#isAdmin}}-->
    <div id="SCORMAdminDialog" title="{{adminDialogTitleLabel}}">

        <form id="settingsForm" method="post">
            <div class="SCORMAdminDialogFields">
                <table>
                    <tbody>
                    <tr>
                        <td class="TableLeftColumn">{{adminDialogServerNameLabel}}</td>
                        <td>
                            <input name="ServerName" type="text" id="SCORMServerName" class="SCORMGreyLabel" value=""/>
                        </td>
                    </tr>
                    <tr>
                        <td class="TableLeftColumn">{{adminDialogDBNameLabel}}</td>
                        <td>
                            <input name="DBName" type="text" id="SCORMDatabaseName" class="SCORMGreyLabel" value=""/>
                        </td>
                    </tr>
                    <tr>
                        <td class="TableLeftColumn">{{adminDialogLoginLabel}}</td>
                        <td>
                            <input name="Login" type="text" id="SCORMDatabaseUserLogin" class="SCORMGreyLabel"
                                   value=""/>
                        </td>
                    </tr>
                    <tr>
                        <td class="TableLeftColumn">{{adminDialogPasswordLabel}}</td>
                        <td>
                            <input name="Password" type="password" id="SCORMDatabaseUserPassword" class="SCORMGreyLabel"
                                   value=""/>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="SCORMAdminDialogButtons">
                <input type="button" id="SCORMRenewDatabaseSettings" class="textbutton" onclick="renewDatabase()"
                       value="{{adminDialogReInitButtonLabel}}"/>

                <div class="float-right" style="float: right;">
                    <input type="button" id="SCORMResetDatabaseSettings" class="textbutton" onclick="resetDBInfo()"
                           value="{{adminDialogResetButtonLabel}}"/>
                    <input type="button" id="SCORMSaveDatabaseSettings" class="textbutton" onclick="saveDatabase()"
                           value="{{adminDialogSaveButtonLabel}}"/>
                </div>
                <div class="clear"></div>
            </div>
        </form>
    </div>
    <!--{{/isAdmin}}-->
    <input type="hidden" id="SCORMContextPath" value="{{contextPath}}"/>
</div>
</body>
</html>
